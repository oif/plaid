name: Release

on:
  push:
    tags:
      - 'v*'

env:
  APP_NAME: Plaid
  SCHEME: Plaid
  BUNDLE_ID: com.plaid.app

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.2'
          
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version $VERSION"
          
      - name: Update version in project
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.version }}" Plaid/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ github.run_number }}" Plaid/Info.plist
          
      - name: Resolve packages
        run: xcodebuild -resolvePackageDependencies -scheme $SCHEME
        
      - name: Build
        run: |
          xcodebuild archive \
            -scheme $SCHEME \
            -configuration Release \
            -archivePath build/$APP_NAME.xcarchive \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
            
      - name: Export app
        run: |
          mkdir -p build/export
          cp -R "build/$APP_NAME.xcarchive/Products/Applications/$APP_NAME.app" build/export/
          
      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "$APP_NAME" \
            --volicon "Plaid/Assets.xcassets/AppIcon.appiconset/icon_512x512@2x.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$APP_NAME.app" 150 190 \
            --app-drop-link 450 190 \
            --no-internet-enable \
            "build/$APP_NAME-${{ steps.version.outputs.version }}.dmg" \
            "build/export/" || true
          
          # Fallback to simple DMG if create-dmg fails
          if [ ! -f "build/$APP_NAME-${{ steps.version.outputs.version }}.dmg" ]; then
            hdiutil create -volname "$APP_NAME" -srcfolder build/export -ov -format UDZO \
              "build/$APP_NAME-${{ steps.version.outputs.version }}.dmg"
          fi
          
      - name: Setup Sparkle
        run: |
          curl -L -o /tmp/Sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz
          mkdir -p /tmp/Sparkle
          tar -xf /tmp/Sparkle.tar.xz -C /tmp/Sparkle
          echo "SPARKLE_BIN=/tmp/Sparkle/bin" >> $GITHUB_ENV
          
      - name: Sign update with Sparkle
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_private_key
          SIGNATURE=$($SPARKLE_BIN/sign_update "build/$APP_NAME-${{ steps.version.outputs.version }}.dmg" -f /tmp/sparkle_private_key)
          echo "SPARKLE_SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
          rm /tmp/sparkle_private_key
          
      - name: Generate appcast item
        run: |
          DMG_SIZE=$(stat -f%z "build/$APP_NAME-${{ steps.version.outputs.version }}.dmg")
          DATE=$(date -R)
          
          cat > build/appcast_item.xml << EOF
          <item>
            <title>Version ${{ steps.version.outputs.version }}</title>
            <pubDate>$DATE</pubDate>
            <sparkle:version>${{ github.run_number }}</sparkle:version>
            <sparkle:shortVersionString>${{ steps.version.outputs.version }}</sparkle:shortVersionString>
            <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
            <enclosure
              url="https://dl.plaid.oo.sb/releases/$APP_NAME-${{ steps.version.outputs.version }}.dmg"
              $SPARKLE_SIGNATURE
              length="$DMG_SIZE"
              type="application/octet-stream" />
            <sparkle:releaseNotesLink>https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}</sparkle:releaseNotesLink>
          </item>
          EOF
          
          cat build/appcast_item.xml
          
      - name: Upload to R2
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          # Install AWS CLI for S3-compatible upload
          brew install awscli
          
          # Configure for R2
          aws configure set aws_access_key_id $R2_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $R2_SECRET_ACCESS_KEY
          aws configure set region auto
          
          R2_ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          
          # Upload DMG
          aws s3 cp "build/$APP_NAME-${{ steps.version.outputs.version }}.dmg" \
            "s3://${R2_BUCKET}/releases/$APP_NAME-${{ steps.version.outputs.version }}.dmg" \
            --endpoint-url $R2_ENDPOINT
            
          # Download existing appcast or create new
          aws s3 cp "s3://${R2_BUCKET}/appcast.xml" build/appcast.xml \
            --endpoint-url $R2_ENDPOINT || cat > build/appcast.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
            <channel>
              <title>Plaid Updates</title>
              <link>https://dl.plaid.oo.sb/appcast.xml</link>
              <description>Plaid app updates</description>
              <language>en</language>
            </channel>
          </rss>
          EOF
          
          # Insert new item (before </channel>)
          sed -i '' '/<\/channel>/i\
          '"$(cat build/appcast_item.xml | tr '\n' '\r' | sed 's/\r/\\n/g')"'
          ' build/appcast.xml
          
          # Upload appcast
          aws s3 cp build/appcast.xml "s3://${R2_BUCKET}/appcast.xml" \
            --endpoint-url $R2_ENDPOINT \
            --content-type "application/xml"
            
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}.dmg
          generate_release_notes: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DMG**: https://dl.plaid.oo.sb/releases/$APP_NAME-${{ steps.version.outputs.version }}.dmg" >> $GITHUB_STEP_SUMMARY
          echo "- **Appcast**: https://dl.plaid.oo.sb/appcast.xml" >> $GITHUB_STEP_SUMMARY
